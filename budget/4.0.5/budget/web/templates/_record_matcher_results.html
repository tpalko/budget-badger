<div id="record_matcher_results" style="display: none">
    <div id="match_errors"></div>
    <div class="row">
        <div class="col-5">            
            <div id="ruleset_evaluated" style="font-family: monospace"></div>
        </div>        
    </div>
    <div class="row">
        <div id="positive-records" class="col-8">        
            <div>
                <h4>Bulk Assignment <span class="bulk_record_count"></span></h4>
                {% include "_record_meta_form.html" %}
            </div>                
            <div id="recordstats"></div>            
            <div id="aggregate"></div>
            <div id="ruleresults"></div>
        </div>
        <div id="negative-records" class="col-8">
            <div>
                <h4>Bulk Assignment <span class="bulk_record_count"></span></h4>
                {% include "_record_meta_form.html" %}
            </div>
            <div id="recordstats"></div>            
            <div id="aggregate"></div>
            <div id="ruleresults"></div>
        </div>
    </div>
    <div class="row">
        <div id="positive-heatmaps" class="col-8">
            <div id="heatmaps"></div>
        </div>
        <div id="negative-heatmaps" class="col-8">
            <div id="heatmaps"></div>
        </div>
    </div>    
</div>

<script language="javascript">

    var controller;
    var form;
    var positive_record_ids;
    var negative_record_ids;
    // var modified_forms = [];

    function recordMatcherSubmit() {

        if (controller != undefined) {
            controller.abort();            
        }

        controller = new AbortController()

        var options = {
            method: "POST",
            body: new FormData(form),
            signal: controller.signal
        }

        var ruleset_submission = fetch("{% url "recordmatcher" tenant_id=1 %}", options)
            .then((response) => {
                controller = undefined;
                return response.json();
            })
            .then(handleMatchResponse)
            .catch((error) => {
                console.error(error);
            });
    }

    function transactionRuleFieldHandler(e) {

        // var event_index = e.target.id.match(/id_form-([0-9]+)/)[1];
        // modified_forms.push(event_index);

        e.preventDefault();

        recordMatcherSubmit();

        return false;
    }

    function handleMatchResponse(data) {
        
        var formErrors = "";

        if (data.form_errors) {            
            formErrors += data.form_errors.join("\n") + "\n";        
        }

        document.querySelector("#form_errors").innerText = formErrors;

        var matchErrors = "";

        if (data.match_errors) {
            for (var name in data.match_errors) {
                matchErrors += name + ": " + data.match_errors[name] + "\n";
            }
        }

        document.querySelector("#match_errors").innerHTML = matchErrors;

        document.querySelector("#record_matcher_results").style.display = "block";

        var positive_records = document.querySelector("#positive-records");
        var positive_heatmaps = document.querySelector("#positive-heatmaps");
        var negative_records = document.querySelector("#negative-records");
        var negative_heatmaps = document.querySelector("#negative-heatmaps");

        positive_records.querySelector("#ruleresults").replaceChildren();        
        negative_records.querySelector("#ruleresults").replaceChildren();        

        if (data.success) {

            document.querySelector("#ruleset_evaluated").innerHTML = data.data.ruleset_evaluated;        
            
            positive_records.querySelector("#recordstats").innerHTML = data.data.positive.recordstats;
            positive_records.querySelector("#aggregate").innerHTML = data.data.positive.aggregate;        
            positive_records.querySelector("#ruleresults").innerHTML = data.data.positive.ruleresults;            
            positive_heatmaps.querySelector("#heatmaps").innerHTML = data.data.positive.heatmaps;
            
            negative_records.querySelector("#recordstats").innerHTML = data.data.negative.recordstats;
            negative_records.querySelector("#aggregate").innerHTML = data.data.negative.aggregate;        
            negative_records.querySelector("#ruleresults").innerHTML = data.data.negative.ruleresults;            
            negative_heatmaps.querySelector("#heatmaps").innerHTML = data.data.negative.heatmaps;
            
            if (data.data.positive.record_ids !== undefined) {
                positive_records.querySelector("form input[name='record_ids']").value = data.data.positive.record_ids;
                positive_records.querySelector(".bulk_record_count").innerHTML = "(" + data.data.positive.record_ids.split(',').length + " records)";
            } else {
                addErrorMessage("The server returned 'undefined' for credit record IDs")
            }
            
            if (data.data.negative.record_ids !== undefined) {
                negative_records.querySelector("form input[name='record_ids']").value = data.data.negative.record_ids;
                negative_records.querySelector(".bulk_record_count").innerHTML = "(" + data.data.negative.record_ids.split(',').length + " records)";
            } else {
                addErrorMessage("The server returned 'undefined' for debit record IDs")
            }

            setRecordTypeSelectListener();
            
            document.querySelectorAll("[class^='heat-']").forEach((el, i) => {
                el.addEventListener('click', (e) => {
                    console.log('this feature is not available yet.. maybe someday it will filter the list of records shown by the region you just clicked on.. ')
                });
            });
        }
        
    }

    function handleRuleFormModified(e) {

        if (!e.target.classList.contains('modified')) {
            e.target.classList.add('modified');
        }
        
        transactionRuleFieldHandler(e);
    }
    /**
     * For given formDiv, attach event listeners for all found ".minusform", "select", and "input"
     * including 'click', 'blur', 'change', and 'keyup'
     */
    function setRuleFormListeners(formDiv) {

        var minusform = formDiv.querySelector(".minusform");

        if (minusform !== null) {
            minusform.addEventListener('click', minusForm);
        }

        formDiv.querySelectorAll("select").forEach((el, i) => {
            el.addEventListener('blur', handleRuleFormModified);
            el.addEventListener('change', handleRuleFormModified);
        })

        formDiv.querySelectorAll("input").forEach((el, i) => {
            el.addEventListener('keyup', handleRuleFormModified);
            el.addEventListener('blur', handleRuleFormModified);
            el.addEventListener('change', handleRuleFormModified);
        })
    }
    /**
     * calls setRuleFormListeners for all "#ruleform .formdiv" and "#ruleset_form" elements
     */
    function setupRecordMatcherResultsEvents() {

        form = document.querySelector("#ruleform");

        form.querySelectorAll(".formdiv").forEach((el, formDivIndex) => {
            setRuleFormListeners(el);
        });

        setRuleFormListeners(document.querySelector("#ruleset_form"));
    }

    function recordMatcherResultsDomContentLoaded(e) {
        setupRecordMatcherResultsEvents();

        {% if transactionruleset_form.id.value %}
        transactionRuleFieldHandler(e);
        {% endif %}
    }

    document.addEventListener('DOMContentLoaded', recordMatcherResultsDomContentLoaded);

</script>