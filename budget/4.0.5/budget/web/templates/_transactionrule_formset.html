{% load budget_tags %}

<div>
    {{ transactionrule_formset.management_form }}
    <div id="transactionrule_formset">
        {% for form in transactionrule_formset %}
            {% for error in form.errors %} 
                {{ error }}
            {% endfor %}
            {{ form.non_form_errors }}
        {% endfor %}
        
        {% for form in transactionrule_formset %}
            <div class="formdiv" id="formdiv-{{ forloop.counter0 }}" data-counter="{{ forloop.counter0 }}">                    
                <span class="formdivcounter">{{ forloop.counter }}</span>: {{ form }} <a href="#" data-formdiv="{{ forloop.counter0 }}" class="minusform">-</a>
            </div>            
        {% endfor %}
    </div>
    <a id="another_form" href="#">+</a>            
</div>

<script language="javascript">

    function renumberFormDivs() {

        var formDivs = document.querySelectorAll(".formdiv");    
        form['form-TOTAL_FORMS'].value = formDivs.length;

        formDivs.forEach((el, formDivIndex) => {

            var beforeCounter = el.dataset.counter;

            el.dataset.counter = formDivIndex;

            el.querySelectorAll("label").forEach((el, i) => {
                el.setAttribute('for', el.getAttribute('for').replace('form-' + beforeCounter, 'form-' + formDivIndex));
            })
            el.querySelectorAll("select").forEach((el, i) => {
                el.name = el.name.replace('form-' + beforeCounter, 'form-' + formDivIndex);
                el.id = el.id.replace('form-' + beforeCounter, 'form-' + formDivIndex);
            })
            el.querySelectorAll("input").forEach((el, i) => {
                el.name = el.name.replace('form-' + beforeCounter, 'form-' + formDivIndex);
                el.id = el.id.replace('form-' + beforeCounter, 'form-' + formDivIndex);
            })
            el.querySelector("span.formdivcounter").innerText = formDivIndex + 1;
            el.querySelector(".minusform").dataset.formdiv = formDivIndex;

            el.id = "formdiv-" + (formDivIndex);
        });
    }

    function minusForm(e) {
        e.preventDefault();
        var index = e.target.dataset.formdiv;
        var total = form['form-TOTAL_FORMS'].value;
        var formdiv = form.querySelector("#formdiv-" + index);

        var description = formdiv.dataset.description;

        document.querySelector("div.token_tags button[data-description='" + description + "']").classList.remove("selected");

        if (total == 1) {
            formdiv.querySelectorAll("input").forEach((e, i) => {
                e.value = "";
            })
        } else {
            formdiv.remove();
        }        
        renumberFormDivs();
        transactionRuleFieldHandler(e);
    }

    function addPopulatedRuleForm(inclusion, field, operator, match_value, event) {
        // TODO: find the bottommost unmodified form, if exists populate that, otherwise add new 

        var formdivs = form.querySelectorAll(".formdiv");
        var index = form['form-TOTAL_FORMS'].value - 1;
        var found_unmodified = false;

        console.debug('found ' + formdivs.length + ' formdivs, current index is ' + index);

        // cycle through all the forms and find the first unmodified AND empty one
        for (i=0; i<formdivs.length; i++) {
            var is_modified = formdivs[i].classList.contains('modified');
            var data_entered = formdivs[i].querySelector("[id$='-match_value']").value != "";

            if (!is_modified && !data_entered) {
                console.debug('formdiv ' + i + '/' + formdivs.length + ' is not modified, no data entered');
                index = i;
                found_unmodified = true;
                break;
            } else {
                console.debug('formdiv ' + i + '/' + formdivs.length + ' modified ' + is_modified + ' data entered ' + data_entered);
            }
        }

        // if we didn't find one to reuse, add a new one
        if (!found_unmodified) {
            console.debug('no unmodified formdiv found, clicking for a new one');
            document.querySelector("#another_form").click();
            index = form['form-TOTAL_FORMS'].value - 1;
            console.debug('new formdiv index is ' + index);
        } else {
            console.debug('an unmodified formdiv was found, using it at index ' + index);
        }
        
        var formdiv = document.querySelector("div.formdiv#formdiv-" + index);
        formdiv.dataset.description = match_value;

        document.querySelector("#id_form-" + index + "-inclusion").value = inclusion;
        document.querySelector("#id_form-" + index + "-record_field").value = field;
        document.querySelector("#id_form-" + index + "-match_operator").value = operator;
        document.querySelector("#id_form-" + index + "-match_value").value = match_value;

        transactionRuleFieldHandler(event);
    }

    function addForm(e) {

        e.preventDefault();
            
        var cloned = document.querySelector(".formdiv[data-counter='0']").cloneNode(true);

        cloned.querySelectorAll("input").forEach((el, i) => {
            if (!el.name.match(/form-[0-9]+-transactionruleset/)) {
                el.value = "";
            }                
        })

        setRuleFormListeners(cloned);

        // var minusLink = document.createElement("a");
        // minusLink.innerText = "-";
        // minusLink.href = "#";
        // minusLink.addEventListener('click', minusForm);
        // cloned.appendChild(minusLink);

        document.querySelector("#transactionrule_formset").append(cloned);
        renumberFormDivs();
    }

    function setupTransactionRuleFormsetEvents() {

        var formset_div = document.querySelector("#transactionrule_formset");

        document.querySelector("#another_form").addEventListener('click', addForm);

        formset_div.querySelectorAll(".minusform").forEach((el, i) => {
            el.addEventListener('click', minusForm);
        })        
    }

    function transactionRuleFormSetDomContentLoaded(e) {
        setupTransactionRuleFormsetEvents();
    }

    document.addEventListener('DOMContentLoaded', transactionRuleFormSetDomContentLoaded);
    
</script>
