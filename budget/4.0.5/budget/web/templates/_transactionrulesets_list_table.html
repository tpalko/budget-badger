{% load budget_tags %}

<div class="row">

    <div class="col-16">
        {% if stats %}
            Total in: ${{ stats|lookup:'totals'|lookup:'earn'|format_currency }}
            <br />
            Total out: ${{ stats|lookup:'totals'|lookup:'spend'|format_currency }}
            <br />
            Total: ${{ stats|lookup:'totals'|lookup:'total'|format_currency }}
            <br />
            Records: {{ stats|lookup:'totals'|lookup:'records' }}
        {% else %}
            I said no stats!
        {% endif %}
    </div>
    
    <div class="col-16">
        <table>
            <tr>
                <th></th>
                <th>Priority</th>
                <th>Ruleset</th>        
                <th># Records</th>
                <th>xAcct</th>
                <th>Period</th>
                <th>$/month in</th>
                <th>$/month out</th>
            </tr>
        {% for transactionruleset in table %}
            <tr id="transactionruleset-{{transactionruleset.id }}" title="{% if transactionruleset.prototransaction %}{{ transactionruleset.prototransaction.stats }}{% endif %}" class="ruleset-status-{% if transactionruleset.prototransaction %}{% if transactionruleset.prototransaction.is_active %}active{% else %}inactive{% endif %}{% else %}unknown{% endif %}">
                <td nowrap>
                    <a href="{%  url "transactionruleset_edit" tenant_id=1 transactionruleset_id=transactionruleset.id %}">edit</a>
                    {% if not transactionruleset.is_auto %}
                    <a href="{%  url "transactionruleset_delete" tenant_id=1 transactionruleset_id=transactionruleset.id %}" class="delete" data-deletecallback="transactionruleset_deleted_handler">delete</a>
                    {% endif %}
                </td>
                <td>{{ transactionruleset.priority }}</td>
                <td title="{% for transactionrule in transactionruleset.transactionrules.all %}#{{ forloop.counter }}. {% if forloop.counter0 > 0 %}{{ transactionruleset.join_operator }} {% endif %}{{ transactionrule.record_field }} {{ transactionrule.match_operator }} {{ transactionrule.match_value}}{% endfor %}">{{ transactionruleset.name }}</td>        
                <td>{{ transactionruleset.records|length }}</td>
                {% if transactionruleset.prototransaction %}
                    <td class="prototransaction-field">{{ transactionruleset.prototransaction.cross_account }}</td>                    
                    <td class="prototransaction-field">{{ transactionruleset.prototransaction.period }}</td>                    
                    <td class="prototransaction-field">{{ transactionruleset.prototransaction.monthly_earn|format_currency }}</td>                    
                    <td class="prototransaction-field">{{ transactionruleset.prototransaction.monthly_spend|format_currency }}</td>                    
                {% else %}
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                {% endif %}
                
            </tr>
        {% endfor %}
        </table>    
    </div>
</div>

{% block script %}

<script language="javascript">

    function transactionruleset_deleted_handler(response) {

        if (response.success) {
            var txrulesetrow = document.querySelector("#transactionruleset-" + response.data.transactionruleset_id);

            if (txrulesetrow === null) {
                alert('the row for transactionruleset ' + response.data.transactionruleset_id + ' could not be found');
                return;             
            }

            txrulesetrow.remove();        
            
        } else {
            alert(response.message);
        }        
    }

</script>

{% endblock %}