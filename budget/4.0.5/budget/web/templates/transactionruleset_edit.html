{% load budget_tags %}

<div class="row">
    <div class="col-16">
        <h3>{% if transactionruleset_form.id.value %}Edit{% else %}New{% endif %} Transaction Rule Set {% if transactionruleset_form.id.value %}{{ transactionruleset_form.id.value }}{% endif %}</h3>
        <div id="form_errors"></div>
    </div>
</div>

<div class="row">
    <div class="col-9">
        {% if transactionruleset_form.id.value %} 
            <form id="ruleform" method="POST" action="{% url "transactionruleset_edit" tenant_id=1 transactionruleset_id=transactionruleset_form.id.value %}">
        {% else %}
            <form id="ruleform" method="POST" action="{% url "transactionruleset_create" tenant_id=1 %}">
        {% endif %}

            {% csrf_token %}

            <div>
                {{ transactionruleset_form.errors }}
                {% for bound_field in transactionruleset_form %} 
                    <div>
                        {% if not bound_field.is_hidden %} 
                            {{ bound_field.label_tag }}
                        {% endif %}
                        {% if bound_field.name == "name" %} 
                            {{ bound_field|tabindex:1 }}
                        {% else %}
                            {{ bound_field|tabindex:2 }}
                        {% endif %}
                    </div>
                {% endfor %}        
            </div>

            {% include "_transactionrule_formset.html" %}

            <input type="submit" name="save" value="save" />
            <a href="{% url "transactionrulesets_list" tenant_id=1 %}">cancel</a>
            
            </form>
    </div>
</div>


<script language="javascript">

    var form;
    
    function formSubmit(e) {

        e.preventDefault();
        
        var options = {
            method: form.method,
            body: new FormData(form),
        }

        var ruleset_submission = fetch(form.action, options)
            .then((response) => {
                controller = undefined;
                var responsej = response.json();
                document.location = '{% url "transactionrulesets_list" tenant_id=1 %}';
                console.error('somehow we did not redirect on the response!')
            })
            .catch((error) => {
                console.error(error);
            });

        return false;
    }

    document.addEventListener('DOMContentLoaded', (e) => {

        form = document.querySelector("#ruleform");

        form.addEventListener('submit', formSubmit);

        // document.querySelector("input[name='rule']").addEventListener('keyup', updateResults);
        // document.querySelector("select[name='operation']").addEventListener('change', updateResults);
        // document.querySelector("select[name='recordfield']").addEventListener('change', updateResults);

    });

</script>
